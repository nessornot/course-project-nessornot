## ADR-002: Стандартизация обработки ошибок по RFC 7807

Дата: 20-10-2025

Статус: Accepted

## Context
- Проблема: Поведение FastAPI и Python при возникновении ошибок по умолчанию может быть небезопасным. Стандартные ответы могут включать специфические имена классов исключений или детали реализации, что нарушает конфиденциальность системы.
- Цель: Создать унифицированный, безопасный и легко отслеживаемый формат ошибок, удобный как для клиентов, так и для мониторинга.

## Decision
Мы принимаем стандарт **RFC 7807** в качестве единого формата для всех ошибок, возвращаемых API.

**Обязательные поля ответа:**
1.  `status` (HTTP-статус)
2.  `title` (Краткое, неизменяемое описание ошибки, например, "Validation Error")
3.  `detail` (Человекочитаемое, безопасное описание. Должно быть высокоуровневым и никогда не содержать внутренней информации)
4.  `type` (URI, определяющий тип проблемы. По умолчанию `about:blank` или ссылка на документацию)
5.  `correlation_id` (Уникальный UUID, генерируемый при возникновении ошибки, для связывания запроса с логами в системе мониторинга)

**Реализация:**
Будут реализованы глобальные обработчики исключений в FastAPI, которые перехватывают нативные ошибки и конвертируют их в JSON-формат RFC 7807.

## Alternatives
1.  **Стандартные HTTP-ответы (Rejected):** Не обеспечивают унифицированной структуры, отсутствует `correlation_id` и маскировка деталей.
2.  **Использование кастомного JSON-формата (Rejected):** Создает технический долг, требует постоянного документирования; RFC 7807 — общепринятый стандарт.

## Consequences
**Плюсы:**
- **Безопасность:** Устраняется риск Information Disclosure, так как внутренние детали маскируются.
- **Наблюдаемость (NFR-08):** Наличие `correlation_id` позволяет быстро находить ошибочные запросы в логах.
- **DX/Интеграция:** Клиентам легче обрабатывать ошибки, так как формат предсказуем.
- Соответствует NFR по безопасности и трассировке.

**Минусы:**
*   Требуется написание и поддержка кастомных обработчиков исключений в коде.

## Links
- **Тест:** `tests/test_cards.py::test_create_card_with_too_long_title_fails_with_rfc7807_error`
