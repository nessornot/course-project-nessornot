## ADR-003: Rate Limiting для защиты от DoS

Дата: 20-10-2025
Статус: Accepted

## Context
- Уязвимость: Эндпоинты, выполняющие ресурсоемкие операции записи (`POST /cards`, `/login`, `/register`), подвержены атакам типа Denial of Service или BruteForce. Неограниченный доступ позволяет злоумышленнику перегрузить базу данных, исчерпать пул соединений или создать избыточное количество сущностей.
- Ограничения: Решение не должно блокировать легитимный, но "всплесковый" трафик полностью, а лишь замедлять его.

## Decision
Вводится лимитирование частоты запросов на критически важные эндпоинты, такие как `POST /cards`.

**Технология:** Будет использоваться библиотека, интегрирующаяся с FastAPI (`slowapi`), которая использует IP-адрес клиента для отслеживания лимитов.

**Политика:**
1.  **Эндпоинт `POST /cards` (Создание карточки):** 5 запросов в 30 секунд (5/30s) на уникальный IP-адрес (для неаутентифицированных) или на User ID (для аутентифицированных).
2.  **Ответ:** При превышении лимита сервер должен вернуть HTTP-статус `429 Too Many Requests`, используя формат RFC 7807, и добавить заголовок `Retry-After`.

**Инфраструктура:** Лимиты будут храниться в памяти приложения или, при масштабировании, в выделенном кеше (Redis).

## Alternatives
1.  **Защита на уровне прокси/балансировщика:** Использовать WAF или встроенный Rate Limiting в Ingress Controller/CDN. Это предпочтительнее в долгосрочной перспективе, но требует инфраструктурных изменений.
2.  **Без Rate Limiting (Rejected):** Нарушает NFR по доступности и оставляет критическую уязвимость DoS.

## Consequences
**Плюсы:**
- **Доступность:** Снижается риск DoS-атак и перегрузки БД.
- **Контроль:** Позволяет защитить от Brute-force атак на `/login`.

**Минусы:**
*   Добавляет задержку и сложность в обработку запросов.
*   Требует настройки политики лимитирования, что может вызвать ложные срабатывания при легитимном всплеске трафика.

## Links
- **NFR:** NFR-06
- **Тест:** `tests/test_cards.py::test_rate_limit_blocks_flood_requests`
